package io.github.notsyncing.lightfur.entity.dsl

import io.github.notsyncing.lightfur.entity.EntityFieldInfo
import io.github.notsyncing.lightfur.entity.EntityModel
import io.github.notsyncing.lightfur.sql.builders.InsertQueryBuilder
import io.github.notsyncing.lightfur.sql.builders.SelectQueryBuilder
import kotlin.reflect.KProperty

class EntityInsertDSL<F: EntityModel>(val insertModel: F) : EntityBaseDSL<F>(insertModel, isInsert = true) {
    override val builder = InsertQueryBuilder()

    init {
        val tableModel = getTableModelFromEntityModel(insertModel)
        builder.into(tableModel)

        for (info in insertModel.primaryKeyFieldInfos) {
            builder.returning(getColumnModelFromEntityFieldInfo(info))
        }
    }

    fun select(query: EntitySelectDSL<*>): EntityInsertDSL<F> {
        insertModel.fieldMap.map { p -> getColumnModelFromEntityFieldInfo(p.value.info) }
                .filter { c -> !c.isAutoGenerated }
                .sortedBy { it.fieldName }
                .forEach { c -> builder.column(c) }

        builder.select(query.toSQLPart() as SelectQueryBuilder)
        return this
    }

    fun values(data: EntityModel? = null, skips: List<KProperty<*>> = emptyList()): EntityInsertDSL<F> {
        val d = data ?: insertModel

        d.fieldMap.map { it }
                .sortedBy { it.key }
                .forEach {
                    val info = d.fieldMap[it.key]!!.info

                    if (info.inner.dbAutoGenerated) {
                        return@forEach
                    }

                    if (skips.any { it.name == info.inner.name }) {
                        return@forEach
                    }

                    builder.column(getColumnModelFromEntityFieldInfo(info), it.value.data)
                }

        return this
    }

    fun skipExisting(): EntityInsertDSL<F> {
        builder.skipExisting()
        return this
    }

    fun updateWhenExists(column: EntityFieldInfo, alterOp: (EntityUpdateDSL<*>) -> Unit): EntityInsertDSL<F> {
        val updateDsl = EntityUpdateDSL(insertModel)
        updateDsl.skipTableName = true

        alterOp(updateDsl)

        builder.whenExists(getColumnModelFromEntityFieldInfo(column), updateDsl.toSQLPart())
        return this
    }
}